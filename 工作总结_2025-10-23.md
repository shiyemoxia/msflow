# MSFlow 项目部署与训练总结

**日期**: 2025年10月23日
**项目**: MSFlow - Multi-Scale Normalizing Flows for Unsupervised Anomaly Detection
**GitHub**: https://github.com/shiyemoxia/msflow

---

## 一、项目部署

### 1.1 环境准备

- **工作目录**: `g:\research\归一化流\msflow`
- **Conda 环境**: 复用了现有的 `cflow-ad` 环境
- **Python 版本**: 3.9
- **主要依赖**:
  - PyTorch 2.4.1 (CUDA 支持)
  - torchvision 0.20.0
  - FrEIA 0.2 (官方版本)
  - scikit-learn, scikit-image
  - wandb (用于实验记录)

### 1.2 仓库克隆

```bash
git clone https://github.com/shiyemoxia/msflow.git msflow
cd msflow
```

### 1.3 遇到的问题及解决方案

#### 问题1: wandb 模块缺失

- **错误**: `ModuleNotFoundError: No module named 'wandb'`
- **原因**: conda 默认频道中没有 wandb
- **解决**:
  ```bash
  pip install wandb -i https://pypi.org/simple
  pip config set global.index-url https://pypi.org/simple
  ```

#### 问题2: FrEIA 版本冲突

- **错误**: `RuntimeError: Expected input of shape (256, 1, 1), got (256, 64, 64)`
- **原因**: cflow-ad 环境中安装的是修改过的本地 FrEIA 版本
- **解决**:
  1. 删除 `FrEIA.egg-link` 文件
  2. 编辑 `easy-install.pth` 移除 FrEIA 引用
  3. 安装官方 FrEIA: `pip install FrEIA`

#### 问题3: NumPy 兼容性问题

- **错误**: `AttributeError: module 'numpy' has no attribute 'bool'`
- **原因**: NumPy 1.20+ 弃用了 `np.bool`
- **解决**: 修改 `evaluations.py`，将 `np.bool` 改为 `np.bool_`
  - 第 68 行
  - 第 69 行
  - 第 50 行

#### 问题4: 显存不足

- **错误**: `CUDA out of memory`
- **原因**: GPU 显存只有 6GB，batch_size=32 太大
- **解决**: 调整 batch_size 为 4

#### 问题5: 测试模式返回值不匹配

- **错误**: `ValueError: too many values to unpack (expected 3)`
- **原因**: `eval_det_loc` 返回 6 个值，但测试模式只接收 3 个
- **解决**: 修改 `train.py` 第 175-177 行，接收所有 6 个返回值

---

## 二、模型训练

### 2.1 训练配置

```bash
python main.py --mode train --dataset mvtec --class-names bottle \
    --meta-epochs 10 --sub-epochs 2 --batch-size 4 --amp_enable
```

### 2.2 训练参数

| 参数                  | 值           | 说明             |
| --------------------- | ------------ | ---------------- |
| dataset               | mvtec        | MVTec AD 数据集  |
| class-names           | bottle       | 训练类别         |
| meta-epochs           | 10           | 元周期数         |
| sub-epochs            | 2            | 子周期数         |
| batch-size            | 4            | 批次大小         |
| amp_enable            | True         | 启用混合精度训练 |
| **总 epoch 数** | **20** | 10 × 2 = 20     |

### 2.3 训练过程

- **开始时间**: 22:17:39
- **结束时间**: 22:30:34
- **总耗时**: 约 13 分钟
- **训练速度**: 约 9.5 FPS

### 2.4 训练结果

#### 性能指标

| Epoch | Det.AUROC         | Loc.AUROC        | 备注                   |
| ----- | ----------------- | ---------------- | ---------------------- |
| 0     | 99.92%            | 95.89%           | 初始性能               |
| 1     | **100.00%** | 98.17%           | **检测达到最佳** |
| 2     | 100.00%           | 98.66%           | -                      |
| 3     | 100.00%           | 98.86%           | -                      |
| 4     | 100.00%           | **98.88%** | **定位达到最佳** |
| 5-9   | 100.00%           | 98.84-98.87%     | 性能稳定               |

#### 最终性能

- **检测 AUROC**: **100.00%** (Epoch 1)
- **定位 AUROC**: **98.88%** (Epoch 4)

#### 与论文对比

| 指标      | 本次训练          | 论文报告 (bottle) | 差距          |
| --------- | ----------------- | ----------------- | ------------- |
| Det.AUROC | **100.00%** | 100.0%            | ✓ 持平       |
| Loc.AUROC | **98.88%**  | 99.0%             | -0.12%        |
| 训练轮数  | 20 epochs         | 100 epochs        | 仅用 1/5 时间 |

**结论**: 仅用 20 个 epoch 就达到了接近论文的性能，说明模型收敛很快。

---

## 三、模型测试

### 3.1 测试命令

```bash
python main.py --mode test --dataset mvtec --class-names bottle \
    --eval_ckpt ./work_dirs/msflow_wide_resnet50_2_avgpool_pl258/mvtec/bottle/best_det.pt
```

### 3.2 测试结果

- **Det.AUROC**: 100.00%
- **Loc.AUROC**: 98.17%
- **推理速度**: 9.6 FPS

### 3.3 保存的模型

模型保存在: `./work_dirs/msflow_wide_resnet50_2_avgpool_pl258/mvtec/bottle/`

| 文件名                | 说明                  | 性能               |
| --------------------- | --------------------- | ------------------ |
| `best_det.pt`       | 检测性能最佳模型      | Det.AUROC: 100.00% |
| `best_loc_auroc.pt` | 定位性能最佳模型      | Loc.AUROC: 98.88%  |
| `last.pt`           | 最后一个 epoch 的模型 | Epoch 9            |

---

## 四、代码修改记录

### 4.1 修改的文件

#### `evaluations.py`

**修改内容**: NumPy 兼容性修复

```python
# 修改前
gt_label = np.asarray(gt_label_list, dtype=np.bool)
gt_mask = np.squeeze(np.asarray(gt_mask_list, dtype=np.bool), axis=1)
binary_score_maps = np.zeros_like(anomaly_score_map, dtype=np.bool)

# 修改后
gt_label = np.asarray(gt_label_list, dtype=np.bool_)
gt_mask = np.squeeze(np.asarray(gt_mask_list, dtype=np.bool_), axis=1)
binary_score_maps = np.zeros_like(anomaly_score_map, dtype=np.bool_)
```

#### `train.py`

**修改内容**: 测试模式返回值修复

```python
# 修改前 (第 175 行)
best_det_auroc, best_loc_auroc, best_loc_pro = eval_det_loc(...)

# 修改后
det_auroc, loc_auroc, loc_pro_auc, \
    best_det_auroc, best_loc_auroc, best_loc_pro = \
        eval_det_loc(...)
```

### 4.2 创建的辅助文件

- `requirements.txt` - 依赖列表（后删除）
- `SETUP_GUIDE.md` - 中文部署指南
- `setup_env.bat` - 环境配置脚本
- `reinstall_freia.bat` - FrEIA 重装脚本
- `check_freia.py` - FrEIA 路径检查脚本
- `find_site_packages.py` - site-packages 路径查找脚本

---

## 五、技术要点总结

### 5.1 归一化流 (Normalizing Flows)

MSFlow 使用归一化流进行无监督异常检测：

- **核心思想**: 只在正常样本上训练，异常样本会得到更低的似然值
- **多尺度设计**: 使用 3 个不同尺度的并行流 + 1 个融合流
- **特征提取**: 使用预训练的 Wide ResNet-50-2

### 5.2 训练策略

- **混合精度训练 (AMP)**: 加速训练并节省显存
- **学习率预热**: 前 3 个 epoch 进行 warmup
- **学习率衰减**: 在 epoch 70 和 90 进行衰减（本次未达到）

### 5.3 评估指标

- **Det.AUROC**: 图像级异常检测的 AUROC
- **Loc.AUROC**: 像素级异常定位的 AUROC
- **PRO**: Per-Region Overlap，区域级评估指标

---

## 六、经验与建议

### 6.1 成功经验

1. **复用环境**: 使用 cflow-ad 环境节省了配置时间
2. **快速迭代**: 先用少量 epoch 验证，确认可行后再完整训练
3. **显存优化**: batch_size=4 + AMP 在 6GB 显存上成功运行
4. **问题定位**: 通过错误信息快速定位并解决兼容性问题

### 6.2 注意事项

1. **FrEIA 版本**: 确保使用官方版本，不要用修改过的版本
2. **NumPy 版本**: 注意 NumPy 1.20+ 的 API 变化
3. **显存管理**: 根据 GPU 显存调整 batch_size
4. **依赖冲突**: 不同项目可能需要不同版本的依赖，建议使用独立环境

### 6.3 改进方向

1. **完整训练**: 使用 100 个 epoch 可能获得更好的定位性能
2. **全类别训练**: 训练所有 15 个 MVTec AD 类别
3. **可视化**: 添加异常热力图可视化功能
4. **模型对比**: 与 CFlow-AD 等其他方法对比性能

---

## 七、下一步计划

### 短期目标

- [ ] 训练更多 MVTec AD 类别（cable, capsule, hazelnut 等）
- [ ] 添加异常检测结果可视化
- [ ] 记录不同类别的性能对比

### 中期目标

- [ ] 完整训练（100 epochs）获得最佳性能
- [ ] 尝试 VisA 数据集
- [ ] 对比不同特征提取器的效果

### 长期目标

- [ ] 理解归一化流的数学原理
- [ ] 尝试改进模型架构
- [ ] 应用到实际工业场景

---

## 八、参考资料

### 论文

- **标题**: MSFlow: Multi-Scale Flow-based Framework for Unsupervised Anomaly Detection
- **作者**: Zhou, Yixuan et al.
- **发表**: TNNLS 2024
- **arXiv**: https://arxiv.org/pdf/2308.15300v1.pdf

### 代码仓库

- **GitHub**: https://github.com/shiyemoxia/msflow
- **FrEIA**: https://github.com/VLL-HD/FrEIA

### 数据集

- **MVTec AD**: https://www.mvtec.com/company/research/datasets/mvtec-ad
- **VisA**: https://amazon-visual-anomaly.s3.us-west-2.amazonaws.com/VisA_20220922.tar

---

## 附录：完整命令记录

### 环境配置

```bash
# 激活环境
conda activate cflow-ad

# 安装 wandb
pip install wandb -i https://pypi.org/simple

# 配置 pip 源
pip config set global.index-url https://pypi.org/simple

# 重装 FrEIA
del E:\Users\shiyanpeng\anaconda3\envs\cflow-ad\lib\site-packages\FrEIA.egg-link
pip install FrEIA
```

### 训练命令

```bash
# 快速训练（20 epochs）
python main.py --mode train --dataset mvtec --class-names bottle \
    --meta-epochs 10 --sub-epochs 2 --batch-size 4 --amp_enable

# 完整训练（100 epochs）
python main.py --mode train --dataset mvtec --class-names bottle \
    --meta-epochs 25 --sub-epochs 4 --batch-size 4 --amp_enable
```

### 测试命令

```bash
python main.py --mode test --dataset mvtec --class-names bottle \
    --eval_ckpt ./work_dirs/msflow_wide_resnet50_2_avgpool_pl258/mvtec/bottle/best_det.pt
```

---

**总结**: 今天成功部署了 MSFlow 项目，解决了多个环境和代码兼容性问题，完成了 bottle 类别的训练和测试，达到了接近论文的性能指标。整个过程积累了丰富的调试经验，为后续的深度学习项目部署打下了良好基础。
